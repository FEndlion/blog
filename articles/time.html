<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>支持跨时区、兼容本地时间不准且不依赖后端接口的倒计时 | 前端名狮</title>
    <meta name="description" content="欢迎关注我的公众号【前端名狮】">
    <link rel="icon" href="/blog/logo.jpg">
    
    <link rel="preload" href="/blog/assets/css/0.styles.429037e2.css" as="style"><link rel="preload" href="/blog/assets/js/app.290bc687.js" as="script"><link rel="preload" href="/blog/assets/js/2.57d79db3.js" as="script"><link rel="preload" href="/blog/assets/js/8.2fba09bd.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.13d03df4.js"><link rel="prefetch" href="/blog/assets/js/11.be41fc50.js"><link rel="prefetch" href="/blog/assets/js/12.ebfdaaa2.js"><link rel="prefetch" href="/blog/assets/js/13.dd5aa02b.js"><link rel="prefetch" href="/blog/assets/js/14.d2ede202.js"><link rel="prefetch" href="/blog/assets/js/15.6aa5f82f.js"><link rel="prefetch" href="/blog/assets/js/16.55209552.js"><link rel="prefetch" href="/blog/assets/js/17.93b79b10.js"><link rel="prefetch" href="/blog/assets/js/18.4811d530.js"><link rel="prefetch" href="/blog/assets/js/19.17b8aa5a.js"><link rel="prefetch" href="/blog/assets/js/20.cab35723.js"><link rel="prefetch" href="/blog/assets/js/21.64633b4e.js"><link rel="prefetch" href="/blog/assets/js/22.1e687b07.js"><link rel="prefetch" href="/blog/assets/js/23.575b31ee.js"><link rel="prefetch" href="/blog/assets/js/24.6b4dba57.js"><link rel="prefetch" href="/blog/assets/js/25.a7b3d390.js"><link rel="prefetch" href="/blog/assets/js/26.b996ce49.js"><link rel="prefetch" href="/blog/assets/js/27.eb4d1b3f.js"><link rel="prefetch" href="/blog/assets/js/3.997a4712.js"><link rel="prefetch" href="/blog/assets/js/4.0745eacd.js"><link rel="prefetch" href="/blog/assets/js/5.a78c4459.js"><link rel="prefetch" href="/blog/assets/js/6.91f7d16a.js"><link rel="prefetch" href="/blog/assets/js/7.db749ca7.js"><link rel="prefetch" href="/blog/assets/js/9.06c824da.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.429037e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">前端名狮</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/articles/" class="nav-link router-link-active">精选文章</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">试题精讲</a></div><div class="nav-item"><a href="/blog/heaven/" class="nav-link">学习园地</a></div> <a href="https://github.com/fe-toplion/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/articles/" class="nav-link router-link-active">精选文章</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">试题精讲</a></div><div class="nav-item"><a href="/blog/heaven/" class="nav-link">学习园地</a></div> <a href="https://github.com/fe-toplion/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>原创文章</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/articles/activityPlatform.html" class="sidebar-link">抛弃jenkins，如何用node从零搭建自动化部署管理平台</a></li><li><a href="/blog/articles/commonPop.html" class="sidebar-link">如何解决弹窗过多，导致的html结构臃肿问题</a></li><li><a href="/blog/articles/time.html" class="active sidebar-link">支持跨时区、兼容本地时间不准且不依赖后端接口的倒计时</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/articles/IntersectionObserver.html" class="sidebar-link">交叉观察器</a></li><li><a href="/blog/articles/browser.html" class="sidebar-link">node实例推导浏览器的渲染机制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="支持跨时区、兼容本地时间不准且不依赖后端接口的倒计时"><a href="#支持跨时区、兼容本地时间不准且不依赖后端接口的倒计时" aria-hidden="true" class="header-anchor">#</a> 支持跨时区、兼容本地时间不准且不依赖后端接口的倒计时</h1> <p><img src="/blog/assets/img/8.a02a557f.png" alt=""></p> <h3 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h3> <p>倒计时是网页中最常见的一种功能，比如淘宝双十一定时抢购、小米手机定时抢购等，这些都是倒计时的常见场景。倒计时也是前端初学者必学的一个demo，正是由于倒计时功能的常见性，导致一些问题常常被忽略，比如：</p> <ol><li>倒计时如何兼容跨时区的问题？</li> <li>在本地时间不准确的情况下，不依赖后端接口，如何保证倒计时精准无误？</li></ol> <p>也许在你刚开始学习前端，写倒计时的时候，并没有考虑上面的问题，但在真正的业务场景中，上面的问题会影响到倒计时的准确性的，是不容忽略的。</p> <h3 id="业务场景"><a href="#业务场景" aria-hidden="true" class="header-anchor">#</a> 业务场景</h3> <blockquote><p>活动页面中需要实现一个倒计时抢票功能，当北京时间为 2025/12/12 00:00:00 的时候，页面“立即抢票”按钮可点击。</p></blockquote> <h3 id="_1-跨时区问题"><a href="#_1-跨时区问题" aria-hidden="true" class="header-anchor">#</a> 1. 跨时区问题</h3> <p>看到上述场景，我们一般会想到下面的常规写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> target <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'2025/12/12 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮可点击'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮不可点击'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上面代码的核心思想：利用当前本地时间和目标时间比较。</p> <p>上面代码看似正确，但没有考虑跨时区问题。北京时间到达了目标时间<code>2025/12/12 00:00:00</code>，由于不同的时区存在时差，其他时区有可能还没有到，所以按照代码逻辑，不同时区的用户有的可以点击抢票按钮，有的不可以，失去了公平性、同时性。</p> <p>下面对时区的相关概念讲解一下：</p> <p><strong>时区</strong></p> <blockquote><p>时区是地球上的区域使用同一个时间定义。以前，人们通过观察太阳的位置（时角）决定时间，这就使得不同经度的地方的时间有所不同（地方时）。1863年，首次使用时区的概念。时区通过设立一个区域的标准时间部分地解决了这个问题。</p></blockquote> <p><strong>地球是自西向东自转，东边比西边先看到太阳，东边的时间也比西边的早。地球自转一周是24小时，所以划分为24个时区，即东1—12区，西1—12区，相邻两个时区的时间相差1小时</strong></p> <blockquote><p>例如，中国东8区的时间总比泰国东7区的时间早1小时，而比日本东9区的时间晚1小时。因此，出国旅行的人，必须随时调整自己的手表，才能和当地时间相一致。凡向西走，每过一个时区，就要把表拨慢1小时（比如2点拨到1点）；凡向东走，每过一个时区，就要把表拨快1小时（比如1点拨到2点）。并且规定英国（格林尼治天文台旧址）为本初子午线，即零度经线</p></blockquote> <p><strong>格林威治时间</strong></p> <p>格林威治子午线上的地方时，或零时区（中时区）的区时叫做格林威治时间，也叫世界时。（更多详细的概念不说了，这里我们不需要。） 比如我们中国是东八区，北京时间是（GMT+08:00）</p> <p><strong>本地与格林威治时间的时差：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>时差 = new Date().getTimezoneOffset(); // 单位是分钟
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>已知格林威治时间，换算本地正确时间：</strong></p> <p>本地时间 = 格林威治时间 - 时差</p> <p><strong>已知本地时间，换算对应格林威治时间：</strong></p> <p>格林威治时间 = 本地时间 + 时差</p> <p><strong>已知本地时间，换算其他时区的时间：</strong></p> <p>因为时区间的差异是以小时为单位的。所以算出0时区的时间后，再减去或加上相应的小时即可（东N区便+N小时，西N区便-N小时）。为了方便计算，东N区记做正数，西N区记做负数。</p> <p>目标时区时间 = 本地时间 + 时差 + 时区间隔</p> <p><strong>所以上面的业务场景，我们就可以把本地时间转换为东八区的北京时间，本地时间和目标倒计时时间都是东八区的时间，两者就可以进行比较判断了。</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> target <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'2025/12/12 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token function">getNowDate</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将本地时间转换为东8区的时间</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮可点击'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮不可点击'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">getNowDate</span><span class="token punctuation">(</span><span class="token parameter">timeZone</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timezone <span class="token operator">=</span> timeZone <span class="token operator">||</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">//目标时区时间，东八区</span>
    <span class="token comment">// 本地时间和格林威治的时间差，单位为分钟</span>
    <span class="token keyword">var</span> offset_GMT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimezoneOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 本地时间距 1970 年 1 月 1 日午夜（GMT 时间）之间的毫秒数</span>
    <span class="token keyword">var</span> nowDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">var</span> targetDate <span class="token operator">=</span> nowDate <span class="token operator">+</span> offset_GMT <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> timezone <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> targetDate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_2-本地时间不准问题"><a href="#_2-本地时间不准问题" aria-hidden="true" class="header-anchor">#</a> 2. 本地时间不准问题</h3> <p>由于人为设置的原因，用户的本地时间，有可能不准确。要想保证倒计时的精确性，一般想到的方法是依赖后端接口，其实不依赖后端接口也可以保证倒计时精准，下面介绍下这两种方法：</p> <p><strong>1. 服务端接口返回当前时间戳</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> targetTime <span class="token operator">=</span>  Date<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'2025/12/12 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> serverTime <span class="token operator">=</span> <span class="token function">getServerTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 请求服务端接口，返回服务器当前时间戳</span>
<span class="token keyword">let</span> localTime <span class="token operator">=</span> <span class="token function">getNowDate</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户本地时间戳</span>

<span class="token keyword">let</span> timeOff <span class="token operator">=</span> serverTime <span class="token operator">-</span> localTime<span class="token punctuation">;</span>
<span class="token keyword">let</span> rightTargetTime <span class="token operator">=</span> targetTime <span class="token operator">-</span> timeOff<span class="token punctuation">;</span> <span class="token comment">// 去除偏差后的目标时间</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>rightTargetTime <span class="token operator">&lt;=</span> localTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮可点击'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮不可点击'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">getNowDate</span><span class="token punctuation">(</span><span class="token parameter">timeZone</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timezone <span class="token operator">=</span> timeZone <span class="token operator">||</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">//目标时区时间，东八区</span>
    <span class="token comment">// 本地时间和格林威治的时间差，单位为分钟</span>
    <span class="token keyword">var</span> offset_GMT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimezoneOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 本地时间距 1970 年 1 月 1 日午夜（GMT 时间）之间的毫秒数</span>
    <span class="token keyword">var</span> nowDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">var</span> targetDate <span class="token operator">=</span> nowDate <span class="token operator">+</span> offset_GMT <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> timezone <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> targetDate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>核心思想：借助服务器接口返回正确的本地时间，然后和用户本地时间作比较，求出偏差值，根据偏差值计算出正确的目标时间。</p> <p><strong>注意：</strong> <code>serverTime</code>返回的是服务器时间，服务器部署在哪个时区，返回的就是哪个时区的时间，所以要确保返回的也是东八区才行。</p> <p><strong>2. Head请求获取服务器时间戳</strong></p> <p><strong>Head 请求</strong></p> <blockquote><p>HEAD方法跟GET方法相同，只不过服务器响应时不会返回消息体。一个HEAD请求的响应中，HTTP头中包含的元信息应该和一个GET请求的响应消息相同。这种方法可以用来获取请求中隐含的元信息，而不用传输实体本身。也经常用来测试超链接的有效性、可用性和最近的修改。</p></blockquote> <p>一个HEAD请求的响应可被缓存，也就是说，响应中的信息可能用来更新之前缓存的实体。如果当前实体跟缓存实体的阈值不同（可通过Content-Length、Content-MD5、ETag或Last-Modified的变化来表明），那么这个缓存就被视为过期了。</p> <p>HEAD请求常常被忽略，但是能提供很多有用的信息，特别是在有限的速度和带宽下。主要有以下特点：</p> <ol><li>只请求资源的首部；</li> <li>检查超链接的有效性；</li> <li>检查网页是否被修改；</li> <li>多用于自动搜索机器人获取网页的标志信息，获取rss种子信息，或者传递安全认证信息等。</li></ol> <p><strong>如何使用Head请求获取服务器时间戳？</strong></p> <p>每个get请求，<code>response header</code>响应头信息中都会返回<strong>当前服务器对应的零时区时间</strong>。</p> <p>每个页面都会有html文档，这个也属于get请求，如下图所示：</p> <p><img src="/blog/assets/img/9.53be9f96.png" alt=""></p> <p>我们可以利用Head请求，拿到这个date头信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>XMLHttpRequest</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;document&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 通过get的方式请求当前文件</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;head&quot;</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 监听请求状态变化</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> time <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        curDate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取响应头里的时间戳</span>
        time <span class="token operator">=</span> xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>得到的<code>time</code>是服务器对应的零时区的时间，通过下面代码可以转换为用户当前所在时区的时间：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/blog/assets/img/10.59bcfb66.png" alt=""></p> <p>所以倒计时代码就可以改写为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>XMLHttpRequest</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;document&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 通过get的方式请求当前文件</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;head&quot;</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 监听请求状态变化</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> time <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        curDate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取响应头里的时间戳</span>
        time <span class="token operator">=</span> xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Date&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> targetTime <span class="token operator">=</span>  Date<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'2025/12/12 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> serverTime <span class="token operator">=</span> <span class="token function">getNowDate</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Head请求，返回服务器当前时间戳</span>
    <span class="token keyword">let</span> localTime <span class="token operator">=</span> <span class="token function">getNowDate</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户本地时间戳</span>
    
    <span class="token keyword">let</span> timeOff <span class="token operator">=</span> serverTime <span class="token operator">-</span> localTime<span class="token punctuation">;</span>
    <span class="token keyword">let</span> rightTargetTime <span class="token operator">=</span> targetTime <span class="token operator">-</span> timeOff<span class="token punctuation">;</span> <span class="token comment">// 去除偏差后的目标时间</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>rightTargetTime <span class="token operator">&lt;=</span> localTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮可点击'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'按钮不可点击'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getNowDate</span><span class="token punctuation">(</span><span class="token parameter">localTime<span class="token punctuation">,</span> timeZone</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timezone <span class="token operator">=</span> timeZone <span class="token operator">||</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">//目标时区时间，东八区</span>
    <span class="token comment">// 本地时间和格林威治的时间差，单位为分钟</span>
    <span class="token keyword">var</span> offset_GMT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTimezoneOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 本地时间距 1970 年 1 月 1 日午夜（GMT 时间）之间的毫秒数</span>
    <span class="token keyword">var</span> nowDate <span class="token operator">=</span> localTime<span class="token punctuation">;</span> 
    <span class="token keyword">var</span> targetDate <span class="token operator">=</span> nowDate <span class="token operator">+</span> offset_GMT <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> timezone <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> targetDate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p><strong>这种方法相比第一种有如下优点：</strong></p> <ol><li>Head请求不需要后端接口支持；</li> <li>由于Head请求不返回消息体、浏览器缓存等原因，该方法性能更高；</li> <li>不需要关注服务器返回的时间戳的时区问题。</li></ol> <h3 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h3> <p>上面的第二种方法就是我们最终想要的，前端可以不依赖后端，实现一个支持跨时区、兼容本地时间不准的倒计时了。</p> <h3 id="关注我"><a href="#关注我" aria-hidden="true" class="header-anchor">#</a> 关注我</h3> <p><strong>扫一扫 关注我的公众号【前端名狮】，更多精彩内容陪伴你！</strong></p> <p><img src="/blog/assets/img/7.3e56d765.png" alt=""></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/fe-toplion/blog/edit/master/docs/articles/time.md" target="_blank" rel="noopener noreferrer">本文源码地址</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">12/16/2019, 9:18:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/articles/commonPop.html" class="prev">如何解决弹窗过多，导致的html结构臃肿问题</a></span> <span class="next"><a href="/blog/articles/IntersectionObserver.html">交叉观察器</a>→
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.290bc687.js" defer></script><script src="/blog/assets/js/2.57d79db3.js" defer></script><script src="/blog/assets/js/8.2fba09bd.js" defer></script>
  </body>
</html>

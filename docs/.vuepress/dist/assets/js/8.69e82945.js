(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{213:function(s,n,e){"use strict";e.r(n);var a=e(0),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"抛弃jenkins，如何用node从零搭建自动化部署管理平台"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#抛弃jenkins，如何用node从零搭建自动化部署管理平台","aria-hidden":"true"}},[s._v("#")]),s._v(" 抛弃jenkins，如何用node从零搭建自动化部署管理平台")]),s._v(" "),e("h2",{attrs:{id:"一、背景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、背景","aria-hidden":"true"}},[s._v("#")]),s._v(" 一、背景")]),s._v(" "),e("p",[s._v("H5页面由于其具有发布灵活、跨平台、易于传播等突出特点，所以H5页面是引流拉新、宣传推广的重要渠道和方式，备受各公司的青睐。")]),s._v(" "),e("p",[s._v("小编的日常工作就是做各种面向用户的H5促销活动的开发，在整个开发周期中，接合我司的一些情况，我总结了H5活动页面的以下特点：")]),s._v(" "),e("ol",[e("li",[s._v("面向用户，流量大；")]),s._v(" "),e("li",[s._v("各端展示方案不同，需要兼容各端（比如活动规则、展示模块，ios和android不一样）；")]),s._v(" "),e("li",[s._v("需求变更频繁；")]),s._v(" "),e("li",[s._v("合作方较多（需要跟各个业务线合作联调）；")]),s._v(" "),e("li",[s._v("排期紧张；")])]),s._v(" "),e("p",[e("strong",[s._v("所以开发测试期间，部署效率就显得特别重要了。")])]),s._v(" "),e("p",[s._v("由于我司的CDN发布平台，需要手动创建模板、粘贴代码，部署效率比较低下；并且活动页面代码分散，无法统一管理和实现工程化，所以决定实现一套自动化部署系统，目前已经投入使用半年时间了，极大地提高了我们的工作效率。"),e("strong",[s._v("我称这个自动化部署系统为【H5 活动管理平台】")]),s._v("。")]),s._v(" "),e("h2",{attrs:{id:"二、h5-活动管理平台自动化部署实现方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、h5-活动管理平台自动化部署实现方案","aria-hidden":"true"}},[s._v("#")]),s._v(" 二、H5 活动管理平台自动化部署实现方案")]),s._v(" "),e("p",[s._v("介绍该平台实现方案之前，先放张效果图，好有一个直观的认识。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/2K5IuDFDWm80vfmibDUibOO4X3HuZCRvcnuibLn9UIDh9qN1bk8HP4TsBfQe7J3mmECagv1WoJxhIvdutL1qg6Vsw/0?wx_fmt=png",alt:"H5活动管理平台界面"}})]),s._v(" "),e("p",[s._v("该平台实现主要依赖于"),e("strong",[s._v("本地开发工程")]),s._v("、"),e("strong",[s._v("gitlab")]),s._v("，三者之间通过通信交互，实现的自动化部署。")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/2K5IuDFDWm80vfmibDUibOO4X3HuZCRvcn6P2hw8tia49vfN9GhEdZlicmGiaDnPIcL5BqfoDriaQscBSib46LKrgIt2g/0?wx_fmt=png",alt:"image"}})]),s._v(" "),e("p",[e("strong",[s._v("最终达到的效果就是：当本地开发分支merge到测试分支devTest或者master分支时，该平台会自动拉取最新代码，构建目标文件，然后将目标文件部署到对应的服务器目录，另外提供了上下线、版本回滚、定时上下线等常用功能。")])]),s._v(" "),e("p",[e("strong",[s._v("整体架构流程图：")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_jpg/2K5IuDFDWm80vfmibDUibOO4X3HuZCRvcn3ofFOTXJic6GEcAhoPpGQ4oHRkvh0icAw9icGys2iay5vjG6J2FnuRKkIw/0?wx_fmt=jpeg",alt:"H5活动管理平台架构流程图"}})]),s._v(" "),e("p",[s._v("下面对一些关键技术点进行详细介绍")]),s._v(" "),e("h3",{attrs:{id:"_1-本地开发工程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-本地开发工程","aria-hidden":"true"}},[s._v("#")]),s._v(" 1. 本地开发工程")]),s._v(" "),e("p",[s._v("我们的本地开发工程，是使用"),e("code",[s._v("node + webpack + babel")]),s._v("等相关技术搭建的多页面开发工程，不同的活动位于不同的目录。因为要做自动化构建部署处理，跟【H5活动管理平台】交互，所以有以下要点需要注意（可根据自己项目情况，自由调整方案）。")]),s._v(" "),e("ol",[e("li",[s._v("本地开发工程作为自动化构建部署的源头，需要提供构建命令行用于构建测试文件和线上文件，便于后面shell命令调用。如在"),e("code",[s._v("package.json")]),s._v("中加入如下命令：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('"scripts": {\n    "local": "cross-env NODE_ENV=local node build.js", // 本地开发命令\n    "build": "cross-env NODE_ENV=product node build.js", // 构建上线文件\n    "test": "cross-env NODE_ENV=test node build.js" // 构建测试文件\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("提供构建配置文件"),e("code",[s._v("dev-config.js")]),s._v("，用于过滤"),e("code",[s._v("webpack")]),s._v("构建时的入口目录，只构建编译当前正在开发的活动页面，提高构建速度。")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("//dev-config.js\nmodule.exports = {\n    devPages: ['test']   //  当前自己正在开发页面目录，不写时会编译所有活动页面\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("提供活动页面目录信息配置"),e("code",[s._v("config.json")]),s._v("，该配置信息用于【H5活动管理平台】的展示，也就是效果图中的信息源。")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// config.json\n{\n  "pages": [\n        {\n            "folder": "lion",\n            "desc": "前端名狮",\n            "author": "诀九",\n            "user": "juejiu"\n        },\n        {\n            "folder": "test",\n            "desc": "活动测试页面",\n            "author": "诀九",\n            "user": "juejiu"\n        }\n    ]\n}\n    \n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("构建生成的 "),e("code",[s._v("JS")]),s._v(" 和 "),e("code",[s._v("HTML")]),s._v(" 文件，存放在 "),e("code",[s._v("dist")]),s._v(" 目录下的对应活动目录中。构建生成的目录结构如下：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("|--dist\n   |-- lion\n       |-- lion_app.js\n       |-- index.html\n   |--test\n       |-- test_app.js\n       |-- index.html\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("提测时，将开发分支merge到devTest分支，上线时，将开发分支merge到master分支。")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://note.youdao.com/yws/public/resource/b301bde589000bc5a9a49d0da467d0ed/xmlnote/B1772927CDF247849E6D385AAD8D473D/3389",alt:"工程目录结构"}})]),s._v(" "),e("h3",{attrs:{id:"_2-gitlab服务器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-gitlab服务器","aria-hidden":"true"}},[s._v("#")]),s._v(" 2. gitlab服务器")]),s._v(" "),e("p",[e("code",[s._v("Gitlab")]),s._v("作为企业代码版本管理工具，提供了"),e("code",[s._v("Webhook")]),s._v("的功能配置，"),e("code",[s._v("Webhook")]),s._v("顾名思义，其实就是一钩子。当我们在"),e("code",[s._v("Gitlab")]),s._v("上做出某些特定操作时，可以触发钩子，去进行一些我们事先设定好的脚本，以达到某些特定功能（例如--前端项目自动发布）。")]),s._v(" "),e("p",[s._v("实际上可以把它理解为回调，或者委托，或者事件通知，归根揭底它就是一个消息通知机制。"),e("strong",[s._v("当gitlab触发某个事件时，它会向你的所配置的http服务发送Post请求")]),s._v("。")]),s._v(" "),e("p",[e("strong",[s._v("注意：")])]),s._v(" "),e("ol",[e("li",[s._v("URL处填写的是【H5活动管理平台】部署的服务器IP;")]),s._v(" "),e("li",[s._v("IP后面跟的"),e("code",[s._v("merge")]),s._v("是该平台提供的一个接口，用于触发钩子后，gitlab服务器向这个接口发送Post请求；")]),s._v(" "),e("li",[e("code",[s._v("Secret Token")]),s._v("处填写的是一个token，主要用于merge接口请求做安全校验，可以随便设置。")])]),s._v(" "),e("p",[s._v("具体配置如下图：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/2K5IuDFDWm80vfmibDUibOO4X3HuZCRvcnvLiaItib90miaicSouOkSQNUwwLExIz8Sgqficaz3DbThmurZdElDPcu1gA/0?wx_fmt=png",alt:"webhooks 配置"}})]),s._v(" "),e("p",[s._v("我们项目是设置的merge钩子，下面只贴一下"),e("code",[s._v("Merge request events")]),s._v("请求传递的数据信息：")]),s._v(" "),e("p",[e("strong",[s._v("Request header:")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("X-Gitlab-Event: Merge Request Hook\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("Request body:")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n  "object_kind": "merge_request",\n  "user": {\n    "name": "Administrator",\n    "username": "root",\n    "avatar_url": "http://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=40\\u0026d=identicon"\n  },\n  "object_attributes": {\n    "id": 99,\n    "target_branch": "master",\n    "source_branch": "ms-viewport",\n    "source_project_id": 14,\n    "author_id": 51,\n    "assignee_id": 6,\n    "title": "MS-Viewport",\n    "created_at": "2013-12-03T17:23:34Z",\n    "updated_at": "2013-12-03T17:23:34Z",\n    "st_commits": null,\n    "st_diffs": null,\n    "milestone_id": null,\n    "state": "opened",\n    "merge_status": "unchecked",\n    "target_project_id": 14,\n    "iid": 1,\n    "description": "",\n    "source":{\n      "name":"Awesome Project",\n      "description":"Aut reprehenderit ut est.",\n      "web_url":"http://example.com/awesome_space/awesome_project",\n      "avatar_url":null,\n      "git_ssh_url":"git@example.com:awesome_space/awesome_project.git",\n      "git_http_url":"http://example.com/awesome_space/awesome_project.git",\n      "namespace":"Awesome Space",\n      "visibility_level":20,\n      "path_with_namespace":"awesome_space/awesome_project",\n      "default_branch":"master",\n      "homepage":"http://example.com/awesome_space/awesome_project",\n      "url":"http://example.com/awesome_space/awesome_project.git",\n      "ssh_url":"git@example.com:awesome_space/awesome_project.git",\n      "http_url":"http://example.com/awesome_space/awesome_project.git"\n    },\n    "target": {\n      "name":"Awesome Project",\n      "description":"Aut reprehenderit ut est.",\n      "web_url":"http://example.com/awesome_space/awesome_project",\n      "avatar_url":null,\n      "git_ssh_url":"git@example.com:awesome_space/awesome_project.git",\n      "git_http_url":"http://example.com/awesome_space/awesome_project.git",\n      "namespace":"Awesome Space",\n      "visibility_level":20,\n      "path_with_namespace":"awesome_space/awesome_project",\n      "default_branch":"master",\n      "homepage":"http://example.com/awesome_space/awesome_project",\n      "url":"http://example.com/awesome_space/awesome_project.git",\n      "ssh_url":"git@example.com:awesome_space/awesome_project.git",\n      "http_url":"http://example.com/awesome_space/awesome_project.git"\n    },\n    "last_commit": {\n      "id": "da1560886d4f094c3e6c9ef40349f7d38b5d27d7",\n      "message": "fixed readme",\n      "timestamp": "2012-01-03T23:36:29+02:00",\n      "url": "http://example.com/awesome_space/awesome_project/commits/da1560886d4f094c3e6c9ef40349f7d38b5d27d7",\n      "author": {\n        "name": "GitLab dev user",\n        "email": "gitlabdev@dv6700.(none)"\n      }\n    },\n    "work_in_progress": false,\n    "url": "http://example.com/diaspora/merge_requests/1",\n    "action": "open",\n    "assignee": {\n      "name": "User1",\n      "username": "user1",\n      "avatar_url": "http://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=40\\u0026d=identicon"\n    }\n  }\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br")])]),e("h3",{attrs:{id:"_3-h5-活动管理平台"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-h5-活动管理平台","aria-hidden":"true"}},[s._v("#")]),s._v(" 3. H5 活动管理平台")]),s._v(" "),e("p",[s._v("当开发者merge代码到GitLab服务器，会触发merge事件，GitLab会发送一个POST请求连带数据（数据格式）给webhooks指定的URL，该平台接收到URL请求后，就涉及如下关键技术点：")]),s._v(" "),e("p",[e("strong",[s._v("1. 根据post请求头信息和和body数据，我们能得到如下信息：")])]),s._v(" "),e("p",[s._v("merge的目标分支： "),e("code",[s._v("req.body.object_attributes.target_branch")]),s._v("；")]),s._v(" "),e("p",[s._v("安全校验token："),e("code",[s._v("req.headers['x-gitlab-token']")]),s._v("；")]),s._v(" "),e("p",[s._v("gitlab工程仓库地址："),e("code",[s._v("req.body.project.git_ssh_url")])]),s._v(" "),e("p",[s._v("触发的钩子行为类型："),e("code",[s._v("req.body.object_attributes.action")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// gitlab触发merge请求\nrouter.post('/merge', function (req, res, next) {\n    let git_ssh_url = req.body.project.git_ssh_url;\n    let name = req.body.project.name;\n    // 上线merge分支master\n    if (req.headers['x-gitlab-token'] == 'mergeRequest' && req.body.object_attributes.target_branch == 'master' && req.body.object_attributes.action == 'merge') {\n        if (config[name] && config[name].git_ssh_url == git_ssh_url) {\n            mergeTaskQueue.addTask(function () {\n                getCode.init(git_ssh_url, name, 'master').then(function (data) {\n                    console.log(data);\n                    mergeTaskQueue.run();\n                }).catch(function (error) {\n                    console.log(error);\n                    mergeTaskQueue.run();\n                })\n            }.bind(null, git_ssh_url, name));\n        }\n        res.end('receive request');\n        // 测试merge分支dev\n    } else if (req.headers['x-gitlab-token'] == 'mergeRequest' && req.body.object_attributes.target_branch == config[name].testEnv.targetBranch && req.body.object_attributes.action == 'merge') {\n        if (config[name] && config[name].git_ssh_url == git_ssh_url) {\n            mergeTaskQueue.addTask(function () {\n                getCode.init(git_ssh_url, name, req.body.object_attributes.target_branch).then(function (data) {\n                    console.log(data);\n                    mergeTaskQueue.run();\n                }).catch(function (error) {\n                    console.log(error);\n                    mergeTaskQueue.run();\n                })\n            }.bind(null, git_ssh_url, name));\n        }\n        res.end('receive request');\n    } else {\n        return res.end('receive request');\n    }\n})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br")])]),e("p",[e("strong",[s._v("2. 执行脚本")])]),s._v(" "),e("p",[s._v("脚本这块没有使用shell脚本，而是使用了node版本的shell.js库，这个库可以让我们控制执行逻辑，更友好的处理错误信息，帮助平台有更友好的信息展示。")]),s._v(" "),e("p",[s._v("拉取最新代码进行构建出目标文件，大致逻辑如下图：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_jpg/2K5IuDFDWm80vfmibDUibOO4X3HuZCRvcnd0j1QqTlEcjb7U60YOvsiasTgosXQzgZpibSWiaxPquHwqLGzbtgCZcLg/0?wx_fmt=jpeg",alt:"目标代码"}})]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("function init(git_ssh_url, projectName, targetBranch) {\n    deferred = Q.defer();\n    if (!git_ssh_url || !projectName) {\n        return deferred.reject('项目地址或者项目名称为空');\n    }\n    repository = git_ssh_url;\n    repositoryName = projectName;\n    clonePath = path.join(__dirname, '../projects/' + projectName);\n\n    shell.exec('exit 0');\n    if (shell.test('-e', clonePath)) {\n        shell.cd(clonePath);\n        let currentBranch = shell.exec('git symbolic-ref --short -q HEAD', {async: false, silent: true}).stdout;\n        if(currentBranch != targetBranch) {\n            let outInfo = shell.exec('git branch', {async: false, silent: true}).stdout;\n            let gitcmd = outInfo.indexOf(targetBranch) >= 0 ? ('git checkout ' + targetBranch) : ('git checkout -b ' + targetBranch + ' origin/' + targetBranch);\n            shell.exec('git pull && ' + gitcmd, {async: false, silent: true});\n        }\n        shell.exec('git pull', {async: false, silent: true}, function (code, stdout, stderr) {\n            if (code != 0) {\n                console.log(stderr);\n                return deferred.reject('git pull error');\n            }\n            console.log(stdout);\n            console.log('git pull run success');\n            return buildTest(projectName, targetBranch);\n        })\n    } else {\n        if (!fs.existsSync(projects_path)) {\n            fs.mkdirSync(projects_path);\n        }\n        shell.cd(projects_path);\n        shell.exec('git clone ' + repository, function (code, stdout, stderr) {\n            if (code != 0) {\n                console.log(stderr);\n                return deferred.reject('git clone error');\n            }\n            console.log('git clone success');\n            shell.cd(clonePath);\n            let outInfo = shell.exec('git branch', {async: false, silent: true}).stdout;\n            let gitcmd = outInfo.indexOf(targetBranch) >= 0 ? ('git checkout ' + targetBranch) : ('git checkout -b ' + targetBranch + ' origin/' + targetBranch);\n            shell.exec(gitcmd, {async: false, silent: true});\n            return buildTest(projectName, targetBranch);\n        })\n    }\n    return deferred.promise;\n}\n\n// 构建项目\nfunction buildTest(projectName, targetBranch) {\n    shell.cd(clonePath);\n    shell.exec('npm config set registry https://registry.npm.taobao.org && npm install', {async: true, silent: true}, function (code, stdout, stderr) {\n        if (code != 0) {\n            console.log(stderr);\n            return deferred.reject('npm install error');\n        }\n        console.log('npm install success');\n        shell.rm('-rf', path.join(clonePath, 'dist'));\n        let testCommand = config[repositoryName].commands.test || 'npm run test'; //构建测试文件命令行\n        shell.exec(testCommand, {async: true, silent: true}, function (code, stdout, stderr) {\n            if (code != 0) {\n                console.log(stderr);\n                return deferred.reject('npm run test fail');\n            }\n            console.log('npm run test success');\n            copyPage(repositoryName, 'test'); // copy到测试目录\n            if(targetBranch != 'master') {\n                shell.exec('exit 0');\n                deferred.resolve('build success and finish');\n                return; // 提测时只构建测试文件\n            }\n            // 构建最终上线文件\n            shell.rm('-rf', path.join(clonePath, 'dist'));\n            let buildCommand = config[repositoryName].commands.build || 'npm run build'; //构建预上线文件命令行\n            shell.exec(buildCommand, {async: true, silent: true}, function (code, stdout, stderr) {\n                if (code != 0) {\n                    console.log(stderr);\n                    return deferred.reject('npm run build fail');\n                }\n                console.log('npm run build success');\n                copyPage(repositoryName, 'online'); //copy到上线正式目录\n                \n                // 每次合并master构建后，都切换到测试分支，便于平台读取config.json信息（测试分支是最新的）\n                shell.exec('git checkout ' + config[projectName].testEnv.targetBranch, {async: false, silent: false}); \n                shell.exec('exit 0');\n                deferred.resolve('build success and finish');\n            })\n        })\n    })\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br")])]),e("p",[e("strong",[s._v("3. 动态扩展项目")])]),s._v(" "),e("p",[s._v("通过修改项目配置文件，接入不同的项目，配置信息有每个项目要上传的CDN路径、构建命令、项目目录展示信息文件路径（"),e("code",[s._v("config.json")]),s._v("），如下图：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 接入该平台的项目列表\nmodule.exports = {\n    'h5-activity-cms': {\n        git_ssh_url: 'git@example.com:awesome_space/awesome_project.git',\n        desc: '前端名狮项目',\n        tabContent: '前端名狮', //页面中tab展示文字\n        onlineParam: { //上传cdn的参数，根据自己项目设置\n            html: {\n                domain: '',\n                path: ''\n            },\n            js: {\n                domain: '',\n                path: ''\n            }\n        },\n        commands: { //构建脚本命令行\n            test: 'npm run test',\n            build: 'npm run build'\n        },\n       \n        configFile: 'config.json', // 活动页面列表信息\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[e("strong",[s._v("4. 队列处理")])]),s._v(" "),e("p",[s._v("构建目标文件的过程中，很多生成文件、压缩、copy的异步操作，不同的merge请求，有可能操作的是同一个文件，所以需要对merge请求做队列处理。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("class TaskQueue {\n    constructor() {\n        this.list = [];\n        this.isRunning = false;\n    }\n    addTask(task) {\n        this.list.push(task);\n        if(this.isRunning) {\n            return;\n        }\n        this.start();\n    }\n    shift() {\n        return this.list.length > 0 ? this.list.shift() : null;\n    }\n    run() {\n        let task = this.shift();\n        if(!task) {\n            this.isRunning = false;\n            return;\n        }\n        task();\n    }\n    start() {\n        this.isRunning = true;\n        this.run();\n    }\n}\nmodule.exports = TaskQueue;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br")])]),e("p",[e("strong",[s._v("5. CDN 发布")])]),s._v(" "),e("p",[s._v("这个需要后端同学提供一个服务接口，用于推送文件到CDN上或者服务器上。我们这边是借助于一个服务端接口，我们通过node上传到他们的服务器，接口方会定时推送文件到CDN，具体每个人的情况处理吧哈。")]),s._v(" "),e("hr"),s._v(" "),e("h2",{attrs:{id:"三、总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、总结","aria-hidden":"true"}},[s._v("#")]),s._v(" 三、总结")]),s._v(" "),e("p",[s._v("该平台使用node实现了一个微型的、类似jenkins功能的部署管理平台，具有如下突出的优点：")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("该平台打通了本地开发环境和测试环境部署，实现了测试部署自动化，节省了人工上传粘贴代码的时间，大大地提高了工作效率；")])]),s._v(" "),e("li",[e("p",[s._v("基于项目工程划分的类别，便于开发者高效率的查找页面；")])]),s._v(" "),e("li",[e("p",[s._v("支持动态扩展，可以通过添加配置文件，接入其他gitlab项目；")])]),s._v(" "),e("li",[e("p",[s._v("可以根据需要定制化平台操作页面，比使用jenkins更灵活，更轻便；")])])]),s._v(" "),e("hr"),s._v(" "),e("p",[e("strong",[s._v("扫一扫 关注我的公众号【前端名狮】，更多精彩内容陪伴你！")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://upload-images.jianshu.io/upload_images/17728790-3301bc6ba92a3f53?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"【前端名狮】"}})])])}),[],!1,null,null,null);n.default=t.exports}}]);